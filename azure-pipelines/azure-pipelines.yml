trigger: none
pr: none

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'
  dotNetVersion: '8.0.x'
  azureServiceConnection: 'Your service connection'

# ============================================================
#  Parameters
# ============================================================
parameters:
  - name: deployToDevTest
    type: boolean
    default: true
    displayName: "Deploy to DevTest Slot"

  - name: deploytostaging
    displayName: "Deploy to Staging Slot"
    type: boolean
    default: false 

  - name: swapToProd
    displayName: "Swap staging slot to production"
    type: boolean
    default: false 

  - name: deployAll
    type: boolean
    default: false
    displayName: "Build  All Function Apps"

  # ────────────────────────────────────────────────
  #  Separator — purely visual (for clean UI layout)
  # ────────────────────────────────────────────────
  - name: showSectionDivider
    type: boolean
    default: false
    displayName: "***** FUNCTION APP SELECTION *****"

# ============================================================
#  FUNCTION APP SELECTION
# ============================================================
# Tick only the apps you want to build & deploy
# If 'deployAll' is true, all below checkboxes are ignored.
# ============================================================  

  - name: funcApp01
    type: boolean
    default: false
    displayName: "Deploy funcApp01"

  - name: funcApp02
    type: boolean
    default: false
    displayName: "Deploy funcApp02"

  - name: funcApp03
    type: boolean
    default: false
    displayName: "Deploy funcApp03"

  - name: funcApp04
    type: boolean
    default: false
    displayName: "Deploy funcApp04"

  - name: funcApp05
    type: boolean
    default: false
    displayName: "Deploy funcApp05"

# ============================================================
#  STAGE 1: BUILD & PACKAGE
# ============================================================
stages:
- stage: Build
  displayName: " Build and Package Selected Function Apps"
  jobs:
  - job: Build_Functions
    steps:
      - checkout: self

      - task: UseDotNet@2
        displayName: 'Install .NET SDK'
        inputs:
          version: $(dotNetVersion)

      - task: NuGetToolInstaller@1
        displayName: 'Install NuGet Tool'

      - task: NuGetAuthenticate@1
        displayName: 'Authenticate to Azure Artifacts feed'

      - task: PowerShell@2
        displayName: " Build & Package Selected Apps"
        inputs:
          targetType: inline
          script: |
            Write-Host " Reading Functionapps.json..."
            $apps = Get-Content "config/Functionapps.json" | ConvertFrom-Json

            # Read all pipeline parameters as JSON
            $paramJson = '${{ convertToJson(parameters) }}' | ConvertFrom-Json

            $selectedApps = @()

            if ($paramJson.deployAll -eq $true) {
              Write-Host " 'deployAll' selected — building all apps."
              $selectedApps = $apps
            } else {
              foreach ($app in $apps) {
                $paramName = $app.name
                if ($paramJson.PSObject.Properties.Name -contains $paramName) {
                  $paramValue = $paramJson.PSObject.Properties[$paramName].Value
                  if ($paramValue -eq $true) {
                    Write-Host " Selected for build: $($app.name)"
                    $selectedApps += $app
                  }
                }
              }
            }

            if ($selectedApps.Count -eq 0) {
              Write-Error " No apps selected for build!"
              exit 1
            }

            # ── NuGet Feed Configuration ─────────────────────────────────
            # If you have a private NuGet feed (e.g. Azure Artifacts),
            # add it as an additional --source below.
            # If you use a feed that requires authentication (e.g. Telerik),
            # add dotnet nuget add source here with your credentials
            # stored as pipeline secret variables.
            # ─────────────────────────────────────────────────────────────

            $publishRoot = "$(Build.ArtifactStagingDirectory)\publish"
            $zipRoot = "$(Build.ArtifactStagingDirectory)\function_zips"
            New-Item -ItemType Directory -Force -Path $publishRoot | Out-Null
            New-Item -ItemType Directory -Force -Path $zipRoot | Out-Null

            foreach ($app in $selectedApps) {
              Write-Host "==========================================="
              Write-Host " Building: $($app.name)"
              Write-Host " Path: $($app.path)"
              Write-Host "==========================================="

              $projectPath = $app.path
              $outputPath = Join-Path $publishRoot $app.name
              $zipFile = Join-Path $zipRoot "$($app.name).zip"

              Write-Host " Restoring NuGet packages..."
              dotnet restore "$projectPath" `
                --source "https://api.nuget.org/v3/index.json" `
                --source "https://pkgs.dev.azure.com/your-org/_packaging/generic-feed/nuget/v3/index.json" `
                
              dotnet build "$projectPath" --configuration $(buildConfiguration)
              dotnet publish "$projectPath" --configuration $(buildConfiguration) --output $outputPath

              Compress-Archive -Path "$outputPath\*" -DestinationPath $zipFile -Force
              Write-Host " Created ZIP for $($app.name)"
            }    
        
      - task: PublishPipelineArtifact@1
        displayName: ' Publish Build Artifacts'
        inputs:
          targetPath: '$(Build.ArtifactStagingDirectory)/function_zips'
          artifactName: 'function_zips'


# ============================================================
#  STAGE: Deploy Function Apps to devtest Slot
# ============================================================
- stage: Deploy
  displayName: "Deploy Function Apps to devtest slot"
  dependsOn: Build
  condition: and(succeeded(), eq(${{ parameters.deployToDevTest }}, true))
  variables:
    paramJson: ${{ convertToJson(parameters) }}

  jobs:
    - job: Deploy_FunctionApps
      displayName: "Deploy Selected Function Apps to devtest slot"
      pool:
        vmImage: 'windows-latest'

      steps:
        - checkout: self
        - download: current
          artifact: function_zips

        # Debug to verify parameters
        - task: PowerShell@2
          displayName: "Debug - Show paramJson"
          inputs:
            targetType: inline
            script: |
              Write-Host "===== DEBUG: paramJson ====="
              Write-Host "${{ variables.paramJson }}"
              Write-Host "============================"

        # Main deployment logic
        - task: AzureCLI@2
          displayName: "Deploy Function Apps to devtest slot"
          inputs:
            azureSubscription: $(azureServiceConnection)
            scriptType: ps
            scriptLocation: inlineScript
            inlineScript: |
              try {
                  # Parse parameter JSON
                  $jsonString = @'
              ${{ variables.paramJson }}
              '@
                  $paramJson = $jsonString | ConvertFrom-Json
                  Write-Host "Parsed parameters successfully."
                  Write-Host "deployAll flag: $($paramJson.deployAll)"

                  # Load Functionapps.json
                  $appsFile = "$(System.DefaultWorkingDirectory)/config/Functionapps.json"
                  if (-not (Test-Path $appsFile)) {
                      Write-Error "Functionapps.json not found at $appsFile"
                      exit 1
                  }

                  Write-Host "Reading Functionapps.json..."
                  $apps = Get-Content $appsFile | ConvertFrom-Json
                  $selectedApps = @()

                  if ($paramJson.deployAll -eq $true) {
                      Write-Host "DeployAll = true; all apps will be deployed."
                      $selectedApps = $apps
                  }
                  else {
                      foreach ($app in $apps) {
                          $paramName = $app.name
                          if ($paramJson.PSObject.Properties.Name -contains $paramName) {
                              $paramValue = $paramJson.$paramName
                              if ($paramValue -eq $true) {
                                  Write-Host "Selected for deployment: $($app.name)"
                                  $selectedApps += $app
                              }
                          }
                      }
                  }

                  if ($selectedApps.Count -eq 0) {
                      Write-Error "No apps selected for deployment."
                      exit 1
                  }

                  foreach ($app in $selectedApps) {
                      $zipPath = "$(Pipeline.Workspace)\function_zips\$($app.name).zip"
                      Write-Host "Checking ZIP path: $zipPath"

                      if (Test-Path $zipPath) {
                          Write-Host "Deploying $($app.name) to resource group $($app.resourceGroup)..."
                          az functionapp deployment source config-zip `
                              --name $app.name `
                              --resource-group $app.resourceGroup `
                              --src $zipPath `
                              --slot devtest `
                              --verbose 

                          if ($LASTEXITCODE -eq 0) {
                              Write-Host "Successfully deployed $($app.name)"
                          } else {
                              Write-Error "Deployment failed for $($app.name)"
                              exit 1
                          }
                      }
                      else {
                          Write-Warning "ZIP file not found for $($app.name): $zipPath"
                      }
                  }

                  Write-Host "All selected Function Apps have been processed."
              }
              catch {
                  Write-Error "Deployment failed: $($_.Exception.Message)"
              }

        - task: AzureCLI@2
          displayName: "Apply App Settings to devtest slot"
          inputs:
            azureSubscription: $(azureServiceConnection)
            scriptType: ps
            scriptLocation: inlineScript
            inlineScript: |
              try {
                  # Parse parameter JSON
                  $jsonString = @'
              ${{ variables.paramJson }}
              '@
                  $paramJson = $jsonString | ConvertFrom-Json

                  # Load Functionapps.json
                  $appsFile = "$(System.DefaultWorkingDirectory)/config/Functionapps.json"
                  if (-not (Test-Path $appsFile)) {
                      Write-Error "Functionapps.json not found at $appsFile"
                      exit 1
                  }

                  $apps = Get-Content $appsFile | ConvertFrom-Json
                  $selectedApps = @()

                  if ($paramJson.deployAll -eq $true) {
                      Write-Host "DeployAll = true; applying settings for all apps."
                      $selectedApps = $apps
                  }
                  else {
                      foreach ($app in $apps) {
                          $paramName = $app.name
                          if ($paramJson.PSObject.Properties.Name -contains $paramName) {
                              $paramValue = $paramJson.$paramName
                              if ($paramValue -eq $true) {
                                  $selectedApps += $app
                              }
                          }
                      }
                  }

                  if ($selectedApps.Count -eq 0) {
                      Write-Warning "No apps selected skipping app settings update."
                      exit 0
                  }

                  foreach ($app in $selectedApps) {
                      $settingsFile = "$(System.DefaultWorkingDirectory)/appsettings/$($app.name)/devtest_appsettings.json"

                      Write-Host "==========================================="
                      Write-Host " App Settings: $($app.name)"
                      Write-Host " Settings file: $settingsFile"
                      Write-Host "==========================================="

                      if (-not (Test-Path $settingsFile)) {
                          Write-Warning "No settings file found for $($app.name) at $settingsFile skipping."
                          continue
                      }

                      $settings = Get-Content $settingsFile | ConvertFrom-Json

                      if ($settings.PSObject.Properties.Count -eq 0) {
                          Write-Warning "Settings file is empty for $($app.name) skipping."
                          continue
                      }

                      # Build key=value array expected by az cli
                      $settingsArgs = $settings.PSObject.Properties | ForEach-Object { "$($_.Name)=$($_.Value)" }

                      Write-Host "Applying $($settings.PSObject.Properties.Count) setting(s) to $($app.name) devtest slot..."

                      az functionapp config appsettings set `
                          --name $app.name `
                          --resource-group $app.resourceGroup `
                          --slot devtest `
                          --settings @settingsArgs `
                          --output none

                      if ($LASTEXITCODE -eq 0) {
                          Write-Host "Successfully applied app settings for $($app.name)"
                      } else {
                          Write-Error "Failed to apply app settings for $($app.name)"
                          exit 1
                      }
                  }

                  Write-Host "All selected Function App settings have been updated."
              }
              catch {
                  Write-Error "App settings update failed: $($_.Exception.Message)"
              }      

# ============================================================
#  STAGE: Deploy Function Apps to Staging Slot
# ============================================================
- stage: Deploy_Staging
  displayName: "Deploy Function Apps (staging slot)"
  dependsOn:
    - Build
  condition: and(succeeded(), eq(${{ parameters.deploytostaging }}, true))
  variables:
    paramJson: ${{ convertToJson(parameters) }}

  jobs:
    # --------------------------------------------------------
    # JOB 1 — Deploy selected apps to staging slot
    # --------------------------------------------------------
    - job: Deploy_Staging
      displayName: " Deploy Selected Function Apps to Staging"
      pool:
        vmImage: 'windows-latest'

      steps:
        - checkout: self
        - download: current
          artifact: function_zips

        # Debug parameters
        - task: PowerShell@2
          displayName: "Debug - Show paramJson"
          inputs:
            targetType: inline
            script: |
              Write-Host "===== DEBUG: paramJson ====="
              Write-Host "${{ variables.paramJson }}"
              Write-Host "============================"

        # Main deployment logic (SAME AS WORKING DEVTEST LOGIC)
        - task: AzureCLI@2
          displayName: "Deploy Function Apps to Staging"
          inputs:
            azureSubscription: $(azureServiceConnection)
            scriptType: ps
            scriptLocation: inlineScript
            inlineScript: |
              try {
                  # Parse parameter JSON
                  $jsonString = @'
              ${{ variables.paramJson }}
              '@
                  $paramJson = $jsonString | ConvertFrom-Json
                  Write-Host "Parsed parameters successfully."
                  Write-Host "deployAll flag: $($paramJson.deployAll)"

                  # Load Functionapps.json
                  $appsFile = "$(System.DefaultWorkingDirectory)/config/Functionapps.json"
                  if (-not (Test-Path $appsFile)) {
                      Write-Error "Functionapps.json not found at $appsFile"
                      exit 1
                  }

                  Write-Host "Reading Functionapps.json..."
                  $apps = Get-Content $appsFile | ConvertFrom-Json
                  $selectedApps = @()

                  if ($paramJson.deployAll -eq $true) {
                      Write-Host "DeployAll = true; all apps will be deployed."
                      $selectedApps = $apps
                  }
                  else {
                      foreach ($app in $apps) {
                          $paramName = $app.name
                          if ($paramJson.PSObject.Properties.Name -contains $paramName) {
                              $paramValue = $paramJson.$paramName
                              if ($paramValue -eq $true) {
                                  Write-Host "Selected for deployment: $($app.name)"
                                  $selectedApps += $app
                              }
                          }
                      }
                  }

                  if ($selectedApps.Count -eq 0) {
                      Write-Error "No apps selected for deployment."
                      exit 1
                  }

                  foreach ($app in $selectedApps) {
                      $zipPath = "$(Pipeline.Workspace)\function_zips\$($app.name).zip"
                      Write-Host "Checking ZIP path: $zipPath"

                      if (Test-Path $zipPath) {
                          Write-Host "Deploying $($app.name) to staging slot..."
                          az functionapp deployment source config-zip `
                              --name $app.name `
                              --resource-group $app.resourceGroup `
                              --src $zipPath `
                              --slot staging `
                              --verbose

                          if ($LASTEXITCODE -eq 0) {
                              Write-Host " Successfully deployed $($app.name)"
                          } else {
                              Write-Error " Deployment failed for $($app.name)"
                              exit 1
                          }
                      }
                      else {
                          Write-Warning " ZIP file not found for $($app.name): $zipPath"
                      }
                  }

                  Write-Host " All selected Function Apps deployed to STAGING slot."
              }
              catch {
                  Write-Error "Deployment failed: $($_.Exception.Message)"
              }
            
        - task: AzureCLI@2
          displayName: "Apply App Settings to staging slot"
          inputs:
            azureSubscription: $(azureServiceConnection)
            scriptType: ps
            scriptLocation: inlineScript
            inlineScript: |
              try {
                  # Parse parameter JSON
                  $jsonString = @'
              ${{ variables.paramJson }}
              '@
                  $paramJson = $jsonString | ConvertFrom-Json

                  # Load Functionapps.json
                  $appsFile = "$(System.DefaultWorkingDirectory)/config/Functionapps.json"
                  if (-not (Test-Path $appsFile)) {
                      Write-Error "Functionapps.json not found at $appsFile"
                      exit 1
                  }

                  $apps = Get-Content $appsFile | ConvertFrom-Json
                  $selectedApps = @()

                  if ($paramJson.deployAll -eq $true) {
                      Write-Host "DeployAll = true; applying settings for all apps."
                      $selectedApps = $apps
                  }
                  else {
                      foreach ($app in $apps) {
                          $paramName = $app.name
                          if ($paramJson.PSObject.Properties.Name -contains $paramName) {
                              $paramValue = $paramJson.$paramName
                              if ($paramValue -eq $true) {
                                  $selectedApps += $app
                              }
                          }
                      }
                  }

                  if ($selectedApps.Count -eq 0) {
                      Write-Warning "No apps selected skipping app settings update."
                      exit 0
                  }

                  foreach ($app in $selectedApps) {
                      $settingsFile = "$(System.DefaultWorkingDirectory)/appsettings/$($app.name)/staging_appsettings.json"

                      Write-Host "==========================================="
                      Write-Host " App Settings: $($app.name)"
                      Write-Host " Settings file: $settingsFile"
                      Write-Host "==========================================="

                      if (-not (Test-Path $settingsFile)) {
                          Write-Warning "No settings file found for $($app.name) at $settingsFile skipping."
                          continue
                      }

                      $settings = Get-Content $settingsFile | ConvertFrom-Json

                      if ($settings.PSObject.Properties.Count -eq 0) {
                          Write-Warning "Settings file is empty for $($app.name) skipping."
                          continue
                      }

                      # Build key=value array expected by az cli
                      $settingsArgs = $settings.PSObject.Properties | ForEach-Object { "$($_.Name)=$($_.Value)" }

                      Write-Host "Applying $($settings.PSObject.Properties.Count) setting(s) to $($app.name) staging slot..."

                      az functionapp config appsettings set `
                          --name $app.name `
                          --resource-group $app.resourceGroup `
                          --slot staging `
                          --settings @settingsArgs `
                          --output none

                      if ($LASTEXITCODE -eq 0) {
                          Write-Host "Successfully applied app settings for $($app.name)"
                      } else {
                          Write-Error "Failed to apply app settings for $($app.name)"
                          exit 1
                      }
                  }

                  Write-Host "All selected Function App settings have been updated."
              }
              catch {
                  Write-Error "App settings update failed: $($_.Exception.Message)"
              }      

    # --------------------------------------------------------
    # JOB 2 — Swap staging slot → production
    # --------------------------------------------------------
    - job: Swap_Staging_to_Prod
      displayName: " Swap staging slot to production"
      dependsOn: Deploy_Staging
      condition: and(succeeded(), eq(${{ parameters.swapToProd }}, true))
      pool:
        vmImage: 'windows-latest'

      steps:
        - checkout: self
        - task: AzureCLI@2
          displayName: "Perform Slot Swap (Staging To Production)"
          inputs:
            azureSubscription: $(azureServiceConnection)
            scriptType: ps
            scriptLocation: inlineScript
            inlineScript: |
              try {
                  Write-Host "===== Starting slot swap: STAGING To PRODUCTION ====="

                  # Load Functionapps.json
                  $appsFile = "$(System.DefaultWorkingDirectory)/config/Functionapps.json"
                  $apps = Get-Content $appsFile | ConvertFrom-Json

                  $jsonString = @'
              ${{ variables.paramJson }}
              '@
                  $paramJson = $jsonString | ConvertFrom-Json
                  $selectedApps = @()

                  if ($paramJson.deployAll -eq $true) {
                      $selectedApps = $apps
                  } else {
                      foreach ($app in $apps) {
                          $paramName = $app.name
                          if ($paramJson.PSObject.Properties.Name -contains $paramName) {
                              $paramValue = $paramJson.$paramName
                              if ($paramValue -eq $true) {
                                  $selectedApps += $app
                              }
                          }
                      }
                  }

                  if ($selectedApps.Count -eq 0) {
                      Write-Host " No apps selected for slot swap."
                      exit 0
                  }

                  foreach ($app in $selectedApps) {
                      Write-Host "Swapping $($app.name) staging To production"
                      az functionapp deployment slot swap `
                          --name $app.name `
                          --resource-group $app.resourceGroup `
                          --slot staging `
                          --target-slot production `
                          --verbose

                      if ($LASTEXITCODE -eq 0) {
                          Write-Host "Swap completed for $($app.name)"
                      } else {
                          Write-Error "Swap failed for $($app.name)"
                      }
                  }

                  Write-Host "=====  All selected Function Apps swapped successfully ====="
              }
              catch {
                  Write-Error "Slot swap failed: $($_.Exception.Message)"
                  exit 1
              }

        - task: AzureCLI@2
          displayName: "Apply App Settings to production"
          inputs:
            azureSubscription: $(azureServiceConnection)
            scriptType: ps
            scriptLocation: inlineScript
            inlineScript: |
              try {
                  # Parse parameter JSON
                  $jsonString = @'
              ${{ variables.paramJson }}
              '@
                  $paramJson = $jsonString | ConvertFrom-Json

                  # Load Functionapps.json
                  $appsFile = "$(System.DefaultWorkingDirectory)/config/Functionapps.json"
                  if (-not (Test-Path $appsFile)) {
                      Write-Error "Functionapps.json not found at $appsFile"
                      exit 1
                  }

                  $apps = Get-Content $appsFile | ConvertFrom-Json
                  $selectedApps = @()

                  if ($paramJson.deployAll -eq $true) {
                      Write-Host "DeployAll = true; applying settings for all apps."
                      $selectedApps = $apps
                  }
                  else {
                      foreach ($app in $apps) {
                          $paramName = $app.name
                          if ($paramJson.PSObject.Properties.Name -contains $paramName) {
                              $paramValue = $paramJson.$paramName
                              if ($paramValue -eq $true) {
                                  $selectedApps += $app
                              }
                          }
                      }
                  }

                  if ($selectedApps.Count -eq 0) {
                      Write-Warning "No apps selected skipping app settings update."
                      exit 0
                  }

                  foreach ($app in $selectedApps) {
                      $settingsFile = "$(System.DefaultWorkingDirectory)/appsettings/$($app.name)/production_appsettings.json"

                      Write-Host "==========================================="
                      Write-Host " App Settings: $($app.name)"
                      Write-Host " Settings file: $settingsFile"
                      Write-Host "==========================================="

                      if (-not (Test-Path $settingsFile)) {
                          Write-Warning "No settings file found for $($app.name) at $settingsFile skipping."
                          continue
                      }

                      $settings = Get-Content $settingsFile | ConvertFrom-Json

                      if ($settings.PSObject.Properties.Count -eq 0) {
                          Write-Warning "Settings file is empty for $($app.name) skipping."
                          continue
                      }

                      # Build key=value array expected by az cli
                      $settingsArgs = $settings.PSObject.Properties | ForEach-Object { "$($_.Name)=$($_.Value)" }

                      Write-Host "Applying $($settings.PSObject.Properties.Count) setting(s) to $($app.name) "

                      az functionapp config appsettings set `
                          --name $app.name `
                          --resource-group $app.resourceGroup `
                          --settings @settingsArgs `
                          --output none

                      if ($LASTEXITCODE -eq 0) {
                          Write-Host "Successfully applied app settings for $($app.name)"
                      } else {
                          Write-Error "Failed to apply app settings for $($app.name)"
                          exit 1
                      }
                  }

                  Write-Host "All selected Function App settings have been updated."
              }
              catch {
                  Write-Error "App settings update failed: $($_.Exception.Message)"
              }      
